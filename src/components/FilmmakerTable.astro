---
import { normalizeUrl } from '../utils/url';
import { FILM_ROLES_BY_CATEGORY } from '../config/roles';
import type { PublicFilmmaker } from '../types/filmmaker';

interface Props {
  filmmakers: PublicFilmmaker[];
}

const { filmmakers } = Astro.props;
---

<div class="filter-container">
  <div class="filter-header-row">
    <button type="button" class="filter-toggle" id="filter-toggle">
      <span class="filter-toggle-text">Filter by role</span>
      <span class="filter-toggle-icon">▼</span>
    </button>
    <span class="filmmaker-count" id="filmmaker-count"></span>
  </div>
  <div class="selected-roles-header"></div>
  <div class="filter-content" id="filter-content">
    <div class="filter-content-inner">
      {Object.entries(FILM_ROLES_BY_CATEGORY).map(([category, rolesObj]) => (
        <div class="filter-section">
          <h4>{category}</h4>
          {Object.keys(rolesObj).sort().map(role => (
            <label><input type="checkbox" value={role}> {role}</label>
          ))}
        </div>
      ))}
    </div>
  </div>
</div>

<div class="table-container">
  <table class="filmmaker-table">
    <thead>
      <tr>
        <th data-sort="name" class="sortable sort-asc">
          Name
          <span class="sort-indicator"></span>
        </th>
        <th data-sort="roles" class="sortable">
          Roles
          <span class="sort-indicator"></span>
        </th>
        <th data-sort="company" class="sortable">
          Company
          <span class="sort-indicator"></span>
        </th>
        <th data-sort="gear" class="sortable">
          Gear
          <span class="sort-indicator"></span>
        </th>
      </tr>
    </thead>
    <tbody>
      {filmmakers.map((filmmaker) => (
        <tr class="filmmaker-row" data-filmmaker-id={filmmaker.id}>
          <td class="name-cell">{filmmaker.name}</td>
          <td>{filmmaker.roles}</td>
          <td>
            {filmmaker.company && filmmaker.website ? (
              <a href={normalizeUrl(filmmaker.website)} target="_blank" rel="noopener noreferrer">{filmmaker.company}</a>
            ) : (
              filmmaker.company || ''
            )}
          </td>
          <td class="gear-cell">{filmmaker.gear || ''}</td>
        </tr>
      ))}
    </tbody>
  </table>
</div>

<style>
  .filter-container {
    margin-bottom: 0;
  }

  .filter-header-row {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .filter-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    transition: all 0.15s;
  }

  .filter-toggle:hover {
    border-color: #667eea;
    color: #667eea;
  }

  .filter-toggle-icon {
    transition: transform 0.2s;
    font-size: 0.625rem;
    opacity: 0.6;
  }

  .filter-toggle.expanded .filter-toggle-icon {
    transform: rotate(180deg);
  }

  .filmmaker-count {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .selected-roles-header:not(:empty) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  :global(.role-filter-tag) {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  :global(.role-filter-tag button) {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    font-size: 1.25rem;
    line-height: 1;
    opacity: 0.8;
    transition: opacity 0.15s;
  }

  :global(.role-filter-tag button:hover) {
    opacity: 1;
  }

  .filter-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                margin 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    margin-top: 0;
    margin-bottom: 0;
  }

  .filter-content > div {
    min-height: 0;
    overflow: hidden;
  }

  .filter-content.expanded {
    grid-template-rows: 1fr;
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .filter-content-inner {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem 2rem;
    padding: 1.5rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .filter-content.expanded .filter-content-inner {
    opacity: 1;
  }

  .filter-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-section h4 {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    margin: 0 0 0.375rem 0;
    letter-spacing: 0.025em;
  }

  .filter-section label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #374151;
    cursor: pointer;
    user-select: none;
  }

  .filter-section label:hover {
    color: #667eea;
  }

  .filter-section input[type="checkbox"] {
    cursor: pointer;
  }

  .table-container {
    overflow-x: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .filmmaker-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }

  .filmmaker-table th {
    background: #f3f4f6;
    color: #374151;
    padding: 0.5rem 0.75rem;
    text-align: left;
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid #e5e7eb;
  }

  .filmmaker-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 2rem;
  }

  .filmmaker-table th.sortable:hover {
    background: #e5e7eb;
  }

  .sort-indicator {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.75rem;
    opacity: 0.5;
  }

  .sort-indicator::after {
    content: '⇅';
  }

  th.sort-asc .sort-indicator::after {
    content: '↑';
    opacity: 1;
  }

  th.sort-desc .sort-indicator::after {
    content: '↓';
    opacity: 1;
  }

  .filmmaker-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .filmmaker-table td:first-child {
    white-space: nowrap;
  }

  .filmmaker-row {
    cursor: pointer;
    transition: background-color 0.15s;
  }

  .filmmaker-row:hover {
    background-color: #f9fafb;
  }

  .filmmaker-table a {
    color: #667eea;
    text-decoration: none;
  }

  .filmmaker-table a:hover {
    text-decoration: underline;
  }

  .gear-cell {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .filter-content-inner {
      grid-template-columns: 1fr;
      padding: 1rem;
    }

    .filter-content.expanded {
      overflow: visible;
    }

    .filmmaker-table th,
    .filmmaker-table td {
      padding: 0.75rem 0.5rem;
      font-size: 0.875rem;
    }

    .gear-cell {
      max-width: 120px;
    }
  }
</style>

<script is:inline id="filmmaker-data" type="application/json" set:html={JSON.stringify(filmmakers)}></script>

<script>
  import type { PublicFilmmaker } from '../types/filmmaker';

  // Load filmmakers from JSON script tag
  const filmmakers: PublicFilmmaker[] = JSON.parse(document.getElementById('filmmaker-data')!.textContent || '[]');
  const filmmakersMap = new Map(filmmakers.map(f => [f.id, f]));

  let currentSort = { column: 'name', direction: 'asc' as 'asc' | 'desc' };
  let selectedRoles: Set<string> = new Set();

  function updateCount() {
    const countEl = document.getElementById('filmmaker-count');
    if (!countEl) return;

    const table = document.querySelector('.filmmaker-table');
    if (!table) return;

    const rows = table.querySelectorAll('.filmmaker-row');
    const totalCount = rows.length;
    const visibleCount = Array.from(rows).filter(row =>
      (row as HTMLElement).style.display !== 'none'
    ).length;

    if (selectedRoles.size === 0) {
      countEl.textContent = `${totalCount} ${totalCount === 1 ? 'filmmaker' : 'filmmakers'}`;
    } else {
      countEl.textContent = `${visibleCount} of ${totalCount} ${totalCount === 1 ? 'filmmaker' : 'filmmakers'}`;
    }
  }

  function setupRoleFilter() {
    const toggle = document.getElementById('filter-toggle');
    const content = document.getElementById('filter-content');
    const checkboxes = document.querySelectorAll('.filter-content input[type="checkbox"]');

    if (!toggle || !content) return;

    // Toggle filter visibility
    toggle.addEventListener('click', () => {
      toggle.classList.toggle('expanded');
      content.classList.toggle('expanded');
    });

    // Handle checkbox changes
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const role = target.value;

        if (target.checked) {
          selectedRoles.add(role);
        } else {
          selectedRoles.delete(role);
        }

        renderSelectedRoles();
        applyFilter();
      });
    });
  }

  function renderSelectedRoles() {
    const container = document.querySelector('.selected-roles-header');
    if (!container) return;

    if (selectedRoles.size === 0) {
      container.innerHTML = '';
      return;
    }

    container.innerHTML = Array.from(selectedRoles).map(role => `
      <span class="role-filter-tag">
        ${role}
        <button type="button" data-role="${role}" aria-label="Remove ${role}">&times;</button>
      </span>
    `).join('');

    // Add click handlers to remove buttons
    container.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const role = btn.getAttribute('data-role');
        if (role) {
          selectedRoles.delete(role);

          // Uncheck the checkbox
          const checkbox = document.querySelector(`.filter-content input[value="${role}"]`) as HTMLInputElement;
          if (checkbox) checkbox.checked = false;

          renderSelectedRoles();
          applyFilter();
        }
      });
    });
  }

  function applyFilter() {
    const table = document.querySelector('.filmmaker-table');
    if (!table) return;

    const rows = table.querySelectorAll('.filmmaker-row');

    rows.forEach(row => {
      const id = parseInt(row.getAttribute('data-filmmaker-id') || '0');
      const filmmaker = filmmakersMap.get(id);
      if (!filmmaker) return;

      const filmmakerRoles = filmmaker.roles.split(',').map(r => r.trim());

      if (selectedRoles.size === 0) {
        (row as HTMLElement).style.display = '';
      } else {
        // Show row if filmmaker has ANY of the selected roles
        const hasMatchingRole = filmmakerRoles.some(role =>
          selectedRoles.has(role)
        );
        (row as HTMLElement).style.display = hasMatchingRole ? '' : 'none';
      }
    });

    updateCount();
  }

  function setupTable() {
    const table = document.querySelector('.filmmaker-table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    headers.forEach(header => {
      header.addEventListener('click', () => {
        const column = header.getAttribute('data-sort');
        if (!column) return;

        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        header.classList.add(`sort-${currentSort.direction}`);

        sortTable(column, currentSort.direction);
      });
    });

    const rows = table.querySelectorAll('.filmmaker-row');
    rows.forEach(row => {
      row.addEventListener('click', (e) => {
        if ((e.target as HTMLElement).tagName === 'A') return;

        const id = parseInt(row.getAttribute('data-filmmaker-id') || '0');
        const filmmaker = filmmakersMap.get(id);
        if (filmmaker) {
          (window as any).openFilmmakerModal(filmmaker);
        }
      });
    });

    // Perform initial sort by name
    sortTable(currentSort.column, currentSort.direction);
  }

  function sortTable(column: string, direction: 'asc' | 'desc') {
    const table = document.querySelector('.filmmaker-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
      const aId = parseInt(a.getAttribute('data-filmmaker-id') || '0');
      const bId = parseInt(b.getAttribute('data-filmmaker-id') || '0');

      const aData = filmmakersMap.get(aId);
      const bData = filmmakersMap.get(bId);

      if (!aData || !bData) return 0;

      let aVal = aData[column as keyof PublicFilmmaker] || '';
      let bVal = bData[column as keyof PublicFilmmaker] || '';

      if (typeof aVal === 'string') aVal = aVal.toLowerCase();
      if (typeof bVal === 'string') bVal = bVal.toLowerCase();

      if (aVal < bVal) return direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return direction === 'asc' ? 1 : -1;
      return 0;
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupRoleFilter();
    setupTable();
    updateCount();
  });
</script>
