---
// Internal imports
import type { SpotlightEvent } from '@db/schema';
import { FILM_GENRES } from '@config/film-genres';
import { formatDate, DATE_LONG } from '@lib/datetime';

interface Props {
  event: SpotlightEvent;
  prefillName?: string;
  prefillEmail?: string;
  isLoggedIn?: boolean;
}

const { event, prefillName = '', prefillEmail = '', isLoggedIn = false } = Astro.props;

const eventDateFormatted = formatDate(event.eventDate, DATE_LONG);
---

<form id="submission-form" class="submission-form">
  <input type="hidden" name="eventId" value={event.id} />

  <div class="form-group">
    <label for="submitterName">Name <span class="required">*</span></label>
    <input type="text" id="submitterName" name="submitterName" required value={prefillName} />
  </div>

  <div class="form-group">
    <label for="submitterEmail">Email <span class="required">*</span></label>
    <input type="email" id="submitterEmail" name="submitterEmail" required value={prefillEmail} />
  </div>

  <div class="form-group">
    <label for="filmTitle">Film Title <span class="required">*</span></label>
    <input type="text" id="filmTitle" name="filmTitle" required />
  </div>

  <div class="form-group">
    <label for="filmGenre">Genre <span class="required">*</span></label>
    <select id="filmGenre" name="filmGenre" required>
      <option value="">Select a genre</option>
      {FILM_GENRES.map((genre) => (
        <option value={genre}>{genre}</option>
      ))}
    </select>
  </div>

  <div class="form-group" id="genre-other-group" style="display: none;">
    <label for="filmGenreOther">Specify Genre <span class="required">*</span></label>
    <input type="text" id="filmGenreOther" name="filmGenreOther" />
  </div>

  <div class="form-group">
    <label for="filmLength">Film Length <span class="required">*</span></label>
    <input
      type="text"
      id="filmLength"
      name="filmLength"
      required
      placeholder="15:30 or 01:15:30"
      pattern="[0-9]{1,2}:[0-9]{2}(:[0-9]{2})?"
    />
    <p class="help-text">Including credits. Format: MM:SS or HH:MM:SS (e.g., 15:30 or 01:15:30)</p>
  </div>

  <div class="form-group">
    <label for="filmLink">Film Link <span class="required">*</span></label>
    <input type="url" id="filmLink" name="filmLink" required placeholder="https://vimeo.com/..." />
    <p class="help-text">Vimeo, YouTube, or other streaming link</p>
  </div>

  <div class="form-group">
    <label for="filmLinkPassword">Link Password</label>
    <input type="text" id="filmLinkPassword" name="filmLinkPassword" />
    <p class="help-text">If your film link is password-protected</p>
  </div>

  <div class="form-group">
    <label class="checkbox-label">
      <input type="checkbox" id="availableInPerson" name="availableInPerson" />
      <span set:html={`I am available to appear in-person at this event on <strong>${eventDateFormatted}</strong>.`} />
    </label>
  </div>

  <div class="form-group">
    <label for="filmmakerNotes">Notes to Us</label>
    <textarea id="filmmakerNotes" name="filmmakerNotes" rows="4" placeholder="Any additional information you'd like us to know"></textarea>
  </div>

  <div id="form-message" class="form-message" style="display: none;"></div>

  <button type="submit" class="btn-primary btn-large" id="submit-btn">Submit Film</button>
</form>

<script id="submission-event-data" type="application/json" set:html={JSON.stringify({
  eventId: event.id,
  slug: event.slug,
  isLoggedIn,
})}></script>

<script>
  import { showFormMessage } from '@lib/form-utils';

  const form = document.getElementById('submission-form') as HTMLFormElement;
  const genreSelect = document.getElementById('filmGenre') as HTMLSelectElement;
  const genreOtherGroup = document.getElementById('genre-other-group') as HTMLDivElement;
  const genreOtherInput = document.getElementById('filmGenreOther') as HTMLInputElement;
  const messageEl = document.getElementById('form-message') as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const meta = JSON.parse(document.getElementById('submission-event-data')?.textContent || '{}');

  // Show/hide "Other" genre input
  genreSelect.addEventListener('change', () => {
    const isOther = genreSelect.value === 'Other';
    genreOtherGroup.style.display = isOther ? 'block' : 'none';
    genreOtherInput.required = isOther;
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    messageEl.style.display = 'none';

    const formData = new FormData(form);
    const data = {
      eventId: Number(formData.get('eventId')),
      submitterName: formData.get('submitterName'),
      submitterEmail: formData.get('submitterEmail'),
      filmTitle: formData.get('filmTitle'),
      filmGenre: formData.get('filmGenre'),
      filmGenreOther: formData.get('filmGenreOther') || null,
      filmLength: formData.get('filmLength'),
      filmLink: formData.get('filmLink'),
      filmLinkPassword: formData.get('filmLinkPassword') || null,
      availableInPerson: formData.get('availableInPerson') === 'on',
      filmmakerNotes: formData.get('filmmakerNotes') || null,
    };

    try {
      const res = await fetch('/api/submissions/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await res.json();

      if (!res.ok) {
        throw new Error(result.error || 'Submission failed');
      }

      // Replace form with success message
      form.innerHTML = `
        <div class="success-message">
          <h2>Thank you for your submission!</h2>
          <p>We've received your film and will review it before the deadline.</p>
          ${meta.isLoggedIn ? '<p><a href="/account/submissions">View My Submissions</a></p>' : ''}
        </div>
      `;
    } catch (err) {
      showFormMessage(messageEl, err instanceof Error ? err.message : 'Something went wrong', 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Film';
    }
  });
</script>

<style>
  .submission-form {
    max-width: 600px;
  }

  .form-group {
    margin-bottom: 1.25rem;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .checkbox-label {
    display: flex;
    gap: 0.5rem;
    align-items: flex-start;
    font-weight: 400;
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    margin-top: 0.25rem;
    flex-shrink: 0;
  }

  input[type="text"],
  input[type="email"],
  input[type="url"],
  select,
  textarea {
    width: 100%;
    padding: 0.65rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-family: inherit;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .required {
    color: #dc2626;
  }

  .help-text {
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }

  .success-message {
    padding: 2rem;
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: var(--radius-lg);
    text-align: center;
  }

  .success-message h2 {
    color: #166534;
    margin-bottom: 0.5rem;
  }

  .success-message a {
    color: var(--color-primary);
    font-weight: 600;
  }
</style>
