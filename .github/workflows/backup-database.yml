name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggers

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check if backup needed
        id: check_changes
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          output=$(npx tsx src/scripts/backup/check-changes.ts)
          echo "$output"

          if echo "$output" | grep -q "SKIP_BACKUP=true"; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Create database backup
        if: steps.check_changes.outputs.skip == 'false'
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          timestamp=$(date -u +"%Y-%m-%dT%H-%M-%S")
          filename="backup-${timestamp}.dump"

          echo "Creating backup: $filename"
          pg_dump "$POSTGRES_URL" \
            -n public \
            -n drizzle \
            -F c \
            --compress=9 \
            -f "$filename"

          echo "Backup created successfully"
          echo "BACKUP_FILE=$filename" >> $GITHUB_ENV

          # Get file size for logging
          size=$(du -h "$filename" | cut -f1)
          echo "Backup size: $size"

      - name: Upload backup artifact
        if: steps.check_changes.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ env.BACKUP_FILE }}
          path: ${{ env.BACKUP_FILE }}
          retention-days: 90 # Keep for 90 days

      - name: Manage backup rotation
        if: steps.check_changes.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # List all backup artifacts
          artifacts=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/artifacts \
            --jq '.artifacts | map(select(.name | startswith("database-backup-"))) | sort_by(.created_at) | reverse')

          # Count total backups
          total=$(echo "$artifacts" | jq 'length')
          echo "Total backups: $total"

          # Delete backups beyond the 30th
          if [ "$total" -gt 30 ]; then
            echo "Deleting $((total - 30)) old backup(s)"
            echo "$artifacts" | jq -r '.[30:] | .[].id' | while read artifact_id; do
              echo "Deleting artifact ID: $artifact_id"
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                /repos/${{ github.repository }}/actions/artifacts/$artifact_id
            done
          fi

      - name: Update last backup timestamp
        if: steps.check_changes.outputs.skip == 'false'
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: npx tsx src/scripts/backup/update-timestamp.ts

      - name: Send failure notification
        if: failure()
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: npx tsx src/scripts/backup/send-alert.ts || true

      - name: Log skip message
        if: steps.check_changes.outputs.skip == 'true'
        run: |
          echo "âœ“ No database changes detected, backup skipped"
          echo "This saves compute time and storage space"
