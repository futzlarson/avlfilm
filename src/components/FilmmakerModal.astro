---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div id={id} class="modal">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <button class="modal-close">&times;</button>
    <div class="modal-body">
      <h2 class="filmmaker-name"></h2>
      <div class="reveal-contact-section">
        <button class="btn-gradient reveal-contact-btn" id="reveal-contact-btn">
          Reveal contact information
        </button>
      </div>
      <table class="filmmaker-details">
        <tbody>
          <tr class="contact-row email-row" style="display: none;">
            <th>Email</th>
            <td><a class="filmmaker-email" href=""></a></td>
          </tr>
          <tr class="contact-row phone-row" style="display: none;">
            <th>Phone</th>
            <td><span class="filmmaker-phone"></span></td>
          </tr>
          <tr>
            <th>Roles</th>
            <td><span class="filmmaker-roles"></span></td>
          </tr>
          <tr class="company-row">
            <th>Company</th>
            <td><span class="filmmaker-company"></span></td>
          </tr>
          <tr class="website-row">
            <th>Website</th>
            <td><span class="filmmaker-website"></span></td>
          </tr>
          <tr class="instagram-row">
            <th>Instagram</th>
            <td><span class="filmmaker-instagram"></span></td>
          </tr>
          <tr class="youtube-row">
            <th>YouTube</th>
            <td><span class="filmmaker-youtube"></span></td>
          </tr>
          <tr class="facebook-row">
            <th>Facebook</th>
            <td><span class="filmmaker-facebook"></span></td>
          </tr>
          <tr class="gear-row">
            <th>Equipment/Gear</th>
            <td><span class="filmmaker-gear"></span></td>
          </tr>
          <tr class="bio-row">
            <th>Bio</th>
            <td><span class="filmmaker-bio"></span></td>
          </tr>
        </tbody>
      </table>
      <div class="claim-account-section" style="display: none;">
        <span class="claim-account-message"></span>
        <a href="/account/claim-profile" class="claim-account-link">Claim this profile</a>
      </div>
    </div>
  </div>
</div>

<style>
  .filmmaker-name {
    margin: 0 0 1rem;
    color: #1a1a1a;
    font-size: 1.75rem;
  }

  .reveal-contact-section {
    margin-bottom: 1.5rem;
  }

  .reveal-contact-btn.hidden {
    display: none !important;
  }

  .filmmaker-details {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .filmmaker-details th {
    text-align: left;
    padding: 0.75rem 1rem;
    background: #f3f4f6;
    color: #374151;
    font-weight: 600;
    font-size: 0.875rem;
    width: 30%;
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
  }

  .filmmaker-details td {
    padding: 0.75rem 1rem;
    color: #1a1a1a;
    border-bottom: 1px solid #e5e7eb;
  }

  .filmmaker-details tr:last-child th,
  .filmmaker-details tr:last-child td {
    border-bottom: none;
  }

  /* Remove border from visible last row when some rows are hidden */
  .filmmaker-details tr[style*="display: none"] {
    display: none !important;
  }

  .filmmaker-details tr:not([style*="display: none"]):last-of-type th,
  .filmmaker-details tr:not([style*="display: none"]):last-of-type td {
    border-bottom: none;
  }

  .filmmaker-details a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .filmmaker-details a:hover {
    text-decoration: underline;
  }

  :global(.filmmaker-instagram a) {
    margin-right: var(--spacing-sm);
  }

  .claim-account-section {
    font-size: smaller;
    margin-top: 1rem;
    margin-bottom: -0.5rem;
    text-align: center;
  }

  @media (max-width: 768px) {
    .filmmaker-name {
      font-size: 1.5rem;
      padding-right: 2rem;
      word-wrap: break-word;
    }

    .filmmaker-details th,
    .filmmaker-details td {
      padding: 0.625rem;
      font-size: 0.875rem;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 0; /* Force table cell to respect word-break */
    }

    .filmmaker-details th {
      width: 35%;
      min-width: 100px;
    }

    .filmmaker-details td {
      width: 65%;
    }
  }
</style>

<script>
  import type { PublicFilmmaker } from '@db/schema';
  import { formatPhone } from '@utils/formatting';
  import { normalizeInstagramUrls, normalizeYoutubeUrl, getInstagramDisplayText, isValidHttpUrl } from '@utils/url';
  import { track } from '@lib/analytics';
  import { setupModal } from '@lib/modal';

  // Helper to safely create a link element
  function createSafeLink(href: string, text: string): HTMLAnchorElement {
    const link = document.createElement('a');
    link.href = href;
    link.textContent = text;
    link.target = '_blank';
    link.rel = 'noopener';

    return link;
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupModal('filmmaker-modal');
  });

  let currentFilmmaker: PublicFilmmaker | null = null;
  const contactCache = new Map<number, { email: string | null; phone: string | null }>(); // Cache contact data

  export function openFilmmakerModal(filmmaker: PublicFilmmaker) {
    const modal = document.getElementById('filmmaker-modal');
    if (!modal) return;

    currentFilmmaker = filmmaker;

    modal.querySelector('.filmmaker-name')!.textContent = filmmaker.name;

    // Check if this filmmaker's contact is in cache
    const cachedContact = contactCache.get(filmmaker.id);

    const revealBtn = document.getElementById('reveal-contact-btn') as HTMLButtonElement;
    const emailRow = modal.querySelector('.email-row') as HTMLElement;
    const phoneRow = modal.querySelector('.phone-row') as HTMLElement;
    const emailLink = modal.querySelector('.filmmaker-email') as HTMLAnchorElement;
    const phoneSpan = modal.querySelector('.filmmaker-phone')!;

    if (cachedContact) {
      // Contact is cached, display it immediately
      revealBtn.classList.add('hidden');

      // Populate email
      if (cachedContact.email) {
        emailLink.textContent = cachedContact.email;
        emailLink.href = `mailto:${cachedContact.email}`;
        emailRow.style.display = 'table-row';
      } else {
        emailRow.style.display = 'none';
      }

      // Populate phone
      if (cachedContact.phone) {
        phoneSpan.textContent = formatPhone(cachedContact.phone);
        phoneRow.style.display = 'table-row';
      } else {
        phoneRow.style.display = 'none';
      }
    } else {
      // Reset to initial state
      if (revealBtn) {
        revealBtn.classList.remove('hidden');
        revealBtn.style.display = 'block';
        revealBtn.disabled = false;
        revealBtn.textContent = 'Reveal contact information';
      }

      // Clear and hide contact rows
      emailLink.textContent = '';
      emailLink.href = '';
      phoneSpan.textContent = '';
      emailRow.style.display = 'none';
      phoneRow.style.display = 'none';
    }

    modal.querySelector('.filmmaker-roles')!.textContent = filmmaker.roles;

    const companyRow = modal.querySelector('.company-row') as HTMLElement;
    const companySpan = modal.querySelector('.filmmaker-company')!;
    if (filmmaker.company) {
      companySpan.textContent = filmmaker.company;
      companyRow.style.display = 'table-row';
    } else {
      companyRow.style.display = 'none';
    }

    // Website
    const websiteRow = modal.querySelector('.website-row') as HTMLElement;
    const websiteSpan = modal.querySelector('.filmmaker-website')!;
    if (filmmaker.website && isValidHttpUrl(filmmaker.website)) {
      websiteSpan.textContent = '';
      websiteSpan.appendChild(createSafeLink(filmmaker.website, filmmaker.website));
      websiteRow.style.display = 'table-row';
    } else {
      websiteRow.style.display = 'none';
    }

    // Instagram - supports multiple handles
    const instagramRow = modal.querySelector('.instagram-row') as HTMLElement;
    const instagramSpan = modal.querySelector('.filmmaker-instagram')!;
    if (filmmaker.instagram) {
      const urls = normalizeInstagramUrls(filmmaker.instagram);
      const texts = getInstagramDisplayText(filmmaker.instagram);

      instagramSpan.textContent = '';
      urls.forEach((url, i) => {
        if (isValidHttpUrl(url)) {
          instagramSpan.appendChild(createSafeLink(url, texts[i]));
        }
      });

      instagramRow.style.display = 'table-row';
    } else {
      instagramRow.style.display = 'none';
    }

    // YouTube
    const youtubeRow = modal.querySelector('.youtube-row') as HTMLElement;
    const youtubeSpan = modal.querySelector('.filmmaker-youtube')!;
    if (filmmaker.youtube) {
      const youtubeUrl = normalizeYoutubeUrl(filmmaker.youtube);
      if (isValidHttpUrl(youtubeUrl)) {
        youtubeSpan.textContent = '';
        youtubeSpan.appendChild(createSafeLink(youtubeUrl, filmmaker.youtube));
        youtubeRow.style.display = 'table-row';
      } else {
        youtubeRow.style.display = 'none';
      }
    } else {
      youtubeRow.style.display = 'none';
    }

    // Facebook
    const facebookRow = modal.querySelector('.facebook-row') as HTMLElement;
    const facebookSpan = modal.querySelector('.filmmaker-facebook')!;
    if (filmmaker.facebook && isValidHttpUrl(filmmaker.facebook)) {
      facebookSpan.textContent = '';
      facebookSpan.appendChild(createSafeLink(filmmaker.facebook, filmmaker.facebook));
      facebookRow.style.display = 'table-row';
    } else {
      facebookRow.style.display = 'none';
    }

    const gearRow = modal.querySelector('.gear-row') as HTMLElement;
    const gearSpan = modal.querySelector('.filmmaker-gear')!;
    if (filmmaker.gear) {
      gearSpan.textContent = filmmaker.gear;
      gearRow.style.display = 'table-row';
    } else {
      gearRow.style.display = 'none';
    }

    const bioRow = modal.querySelector('.bio-row') as HTMLElement;
    const bioSpan = modal.querySelector('.filmmaker-bio')!;
    if (filmmaker.bio) {
      bioSpan.textContent = filmmaker.bio;
      bioRow.style.display = 'table-row';
    } else {
      bioRow.style.display = 'none';
    }

    // Claim account section
    const claimSection = modal.querySelector('.claim-account-section') as HTMLElement;
    const claimMessage = modal.querySelector('.claim-account-message'); 
    if (!filmmaker.hasPassword) {
      claimMessage.innerHTML = `Are you ${filmmaker.name}?`; 
      claimSection.style.display = 'block';
    } else {
      claimSection.style.display = 'none';
    }

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  (window as any).openFilmmakerModal = openFilmmakerModal;

  // Setup reveal contact functionality
  document.addEventListener('DOMContentLoaded', () => {
    const revealBtn = document.getElementById('reveal-contact-btn');

    if (revealBtn) {
      revealBtn.addEventListener('click', handleRevealContact);
    }
  });

  async function fetchAndDisplayContact(filmmakerId: number, modal: HTMLElement) {
    const emailRow = modal.querySelector('.email-row') as HTMLElement;
    const phoneRow = modal.querySelector('.phone-row') as HTMLElement;

    try {
      const response = await fetch('/api/reveal-contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filmmakerId }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to load contact information');
      }

      const data = await response.json();

      // Populate email
      const emailLink = modal.querySelector('.filmmaker-email') as HTMLAnchorElement;
      if (data.email) {
        emailLink.textContent = data.email;
        emailLink.href = `mailto:${data.email}`;
        emailRow.style.display = 'table-row';
      }

      // Populate phone
      const phoneSpan = modal.querySelector('.filmmaker-phone')!;
      if (data.phone) {
        phoneSpan.textContent = formatPhone(data.phone);
        phoneRow.style.display = 'table-row';
      }

      // Cache the contact data
      contactCache.set(filmmakerId, {
        email: data.email || null,
        phone: data.phone || null,
      });
    } catch (error) {
      console.error('Error revealing contact:', error);
      throw error;
    }
  }

  async function handleRevealContact() {
    const modal = document.getElementById('filmmaker-modal');
    if (!modal || !currentFilmmaker) return;

    // Track reveal event
    track('directory_reveal_contact_click', {
      filmmaker_name: currentFilmmaker.name.substring(0, 255),
      filmmaker_id: currentFilmmaker.id.toString()
    });

    const revealBtn = document.getElementById('reveal-contact-btn') as HTMLButtonElement;
    if (!revealBtn) return;

    // Disable button and show loading state
    revealBtn.disabled = true;
    revealBtn.textContent = 'Loading...';

    try {
      await fetchAndDisplayContact(currentFilmmaker.id, modal);

      // Hide button
      revealBtn.classList.add('hidden');
    } catch (error) {
      // Show error message and re-enable button
      revealBtn.textContent = error instanceof Error ? error.message : 'Error loading contact info';
      revealBtn.disabled = false;

      // Reset button text after 3 seconds
      setTimeout(() => {
        revealBtn.textContent = 'Reveal contact information';
      }, 3000);
    }
  }
</script>
