---
// Internal imports
import { db } from '@db';
import { spotlightEvents } from '@db/schema';
import BaseLayout from '@layouts/BaseLayout.astro';
import SubmissionForm from '@components/SubmissionForm.astro';

// External packages
import { eq } from 'drizzle-orm';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch the event
const [event] = await db
  .select()
  .from(spotlightEvents)
  .where(eq(spotlightEvents.slug, slug));

if (!event) {
  return new Response(null, { status: 404, statusText: 'Event not found' });
}

// Check if deadline has passed
const deadlinePassed = new Date() > event.submissionDeadline;
const daysRemaining = Math.ceil((event.submissionDeadline.getTime() - Date.now()) / (1000 * 60 * 60 * 24));

// Pre-fill from logged-in user if available
const user = Astro.locals.user;
let prefillName = '';
let prefillEmail = '';

if (user) {
  // Import here to avoid unnecessary DB call when not logged in
  const { findUserById } = await import('@lib/auth');
  const filmmaker = await findUserById(user.userId);
  if (filmmaker) {
    prefillName = filmmaker.name;
    prefillEmail = filmmaker.email;
  }
}

const format = {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: 'numeric',
  minute: '2-digit',
} as const;
const eventFormatted = event.eventDate.toLocaleDateString('en-US', format);
const deadlineFormatted = event.submissionDeadline.toLocaleDateString('en-US', format);
---

<BaseLayout
  title={`Submit Film for Spotlight - ${event.title}`}
  description={`Submit your film for ${event.title}${event.theme ? ` (${event.theme})` : ''}.`}
>
  <div class="header-section">
    <h1>Submit your film for Spotlight</h1>
    <div class="event-details">
      <h2>{event.title}</h2>
      {event.theme && <p class="theme">{event.theme}</p>}
      <p class="event-date">{eventFormatted}</p>
    </div>
  </div>

  {deadlinePassed ? (
    <div class="alert alert-error">
      <strong>Submissions are closed.</strong> The deadline for this event was {deadlineFormatted}.
    </div>
  ) : (
    <>
      <div class="submission-info">
        <p class="deadline-info">
          <strong>Submission deadline:</strong> {deadlineFormatted}
          <span class="remaining">({daysRemaining === 1 ? '1 day remaining' : `${daysRemaining} days remaining`})</span>
        </p>
        <p class="free-ticket"><em>Accepted films receive one free admission ticket.</em></p>
      </div>

      <SubmissionForm
        event={event}
        prefillName={prefillName}
        prefillEmail={prefillEmail}
        isLoggedIn={!!user}
      />
    </>
  )}
</BaseLayout>

<style>
  .header-section {
    margin-bottom: 2rem;
  }

  .header-section h1 {
    margin-bottom: 1rem;
  }

  .event-details {
    background: var(--color-bg-subtle);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    border-left: 4px solid var(--color-primary);
  }

  .event-details h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
  }

  .theme {
    color: var(--color-primary);
    font-weight: 600;
    margin: 0 0 0.75rem 0;
  }

  .event-date {
    margin: 0;
    font-weight: 500;
  }

  .submission-info {
    background: var(--color-info-bg);
    border: 1px solid var(--color-info-border);
    border-radius: var(--radius-md);
    padding: 1rem 1.25rem;
    margin-bottom: 2rem;
  }

  .submission-info p {
    margin: 0.5rem 0;
  }

  .submission-info p:first-child {
    margin-top: 0;
  }

  .submission-info p:last-child {
    margin-bottom: 0;
  }

  .deadline-info {
    font-size: 1.05rem;
  }

  .remaining {
    color: var(--color-info-text);
    font-weight: 600;
  }

  .free-ticket {
    font-size: 0.95rem;
    color: var(--color-info-text);
  }

  .alert {
    padding: 1rem 1.25rem;
    border-radius: var(--radius-md);
    margin-bottom: 1.5rem;
  }

  .alert-error {
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }
</style>
