---
import BaseLayout from '../layouts/BaseLayout.astro';
import { FILM_ROLES_BY_CATEGORY } from '../config/roles';

// Build a flat lookup map for client-side normalization (simple object that can be serialized)
const roleAliasMap: Record<string, string> = {};
for (const rolesObj of Object.values(FILM_ROLES_BY_CATEGORY)) {
  for (const [canonical, aliases] of Object.entries(rolesObj)) {
    roleAliasMap[canonical.toLowerCase()] = canonical;
    for (const alias of aliases) {
      roleAliasMap[alias.toLowerCase()] = canonical;
    }
  }
}

const canonicalRoles = Object.values(FILM_ROLES_BY_CATEGORY).flatMap(rolesObj => Object.keys(rolesObj));
---

<BaseLayout
  title="Submit to Filmmaker Directory"
  description="Join the AVL Film filmmaker directory. Add your profile to connect with the film community in Asheville and Western North Carolina."
>
  <h1>Add Yourself to the Filmmaker Directory</h1>
  <p class="intro">Join the AVL Film community! Fill out the form below to be listed in our filmmaker directory.</p>

  <form id="submit-form" class="filmmaker-form">
    <div class="form-group">
      <label for="name">Name <span class="required">*</span></label>
      <input type="text" id="name" name="name" required />
    </div>

    <div class="form-group">
      <label for="email">Email <span class="required">*</span></label>
      <input type="email" id="email" name="email" required />
      <div id="email-error" class="error-text" style="display: none;"></div>
    </div>

    <div class="form-group">
      <label for="phone">Phone</label>
      <input type="tel" id="phone" name="phone" placeholder="###-###-####" />
    </div>

    <div class="form-group">
      <label for="roles">Roles <span class="required">*</span></label>
      <div class="autocomplete-container">
        <input
          type="text"
          id="roles-input"
          placeholder="Start typing to select roles"
          autocomplete="off"
        />
        <div id="roles-dropdown" class="autocomplete-dropdown"></div>
      </div>
      <div id="selected-roles" class="selected-roles"></div>
      <input type="hidden" id="roles" name="roles" required />
    </div>

    <div class="form-group">
      <label for="company">Company</label>
      <input type="text" id="company" name="company" />
    </div>

    <div class="form-group">
      <label for="website">Website</label>
      <input type="url" id="website" name="website" placeholder="https://example.com" />
    </div>

    <div class="form-group">
      <label for="socialMedia">Social Media</label>
      <input type="text" id="socialMedia" name="socialMedia" placeholder="@username or profile URL" />
    </div>

    <div class="form-group">
      <label for="gear">Equipment/Gear</label>
      <textarea id="gear" name="gear" rows="4" placeholder="List your equipment and gear"></textarea>
    </div>

    <div class="form-group">
      <label for="notes">Notes for AVL Film</label>
      <textarea id="notes" name="notes" rows="3" placeholder="Any additional information you'd like to share with us"></textarea>
    </div>

    <div class="form-group checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" id="newsletter" name="newsletter" checked />
        <span>Sign me up for the AVL Film newsletter</span>
      </label>
    </div>

    <button type="submit" class="btn-primary btn-large">Submit</button>
  </form>

  <div id="success-message" class="success-message" style="display: none;">
    <h2>Thank you for submitting!</h2>
    <p>Your submission has been received and will be reviewed by our team. You'll be added to the directory once approved.</p>
    <a href="/directory" class="back-link">Back to Directory</a>
  </div>
</BaseLayout>

<style>
  .filmmaker-form {
    max-width: 600px;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group:has(#roles-input) {
    margin-bottom: 0.75rem;
  }


  .autocomplete-container {
    position: relative;
  }

  .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #d1d5db;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    z-index: 10;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .autocomplete-dropdown.active {
    display: block;
  }

  :global(.autocomplete-item) {
    padding: 0.875rem 1rem;
    cursor: pointer;
    transition: background-color 0.15s;
  }

  :global(.autocomplete-item:hover) {
    background-color: #f3f4f6;
  }

  .selected-roles {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem;
    margin-top: 0.75rem;
  }

  :global(.role-tag) {
    background: var(--gradient-primary);
    color: white;
    padding: 0.625rem 1.125rem;
    border-radius: 50px;
    font-size: 0.9375rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    transition: all 0.2s ease;
  }

  :global(.role-tag:hover) {
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
    transform: translateY(-1px);
  }

  :global(.role-tag button) {
    background: rgba(255, 255, 255, 0.25);
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.125rem;
    line-height: 1;
    padding: 0.25rem;
    width: 1.375rem;
    height: 1.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
    font-weight: bold;
    margin-left: 0.125rem;
  }

  :global(.role-tag button:hover) {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
  }


  .success-message {
    max-width: 600px;
    margin: 2rem auto;
    padding: 2rem;
    background: #f0fdf4;
    border: 2px solid #86efac;
    border-radius: var(--radius-lg);
    text-align: center;
  }

  .success-message h2 {
    color: #166534;
    margin-bottom: 1rem;
  }

  .success-message p {
    color: #166534;
    margin-bottom: 1.5rem;
  }

  .back-link {
    display: inline-block;
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .error-text {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.5rem;
  }

  .checkbox-group {
    margin-bottom: 2rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-size: 1rem;
  }

  .checkbox-label input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
  }

  .checkbox-label span {
    user-select: none;
  }
</style>

<script is:inline id="roles-data" type="application/json" set:html={JSON.stringify(canonicalRoles)}></script>
<script is:inline id="role-map-data" type="application/json" set:html={JSON.stringify(roleAliasMap)}></script>

<script>
  import { track } from '../lib/analytics';

  // Load roles data from JSON script tags
  const roles: string[] = JSON.parse(document.getElementById('roles-data')!.textContent || '[]');
  const roleMap: Record<string, string> = JSON.parse(document.getElementById('role-map-data')!.textContent || '{}');

  const selectedRoles = new Set<string>();

  function updateSelectedRoles() {
    const container = document.getElementById('selected-roles');
    const hiddenInput = document.getElementById('roles') as HTMLInputElement;

    if (!container || !hiddenInput) return;

    container.innerHTML = '';

    selectedRoles.forEach(role => {
      const tag = document.createElement('div');
      tag.className = 'role-tag';
      tag.innerHTML = `
        <span>${role}</span>
        <button type="button" data-role="${role}">&times;</button>
      `;

      const btn = tag.querySelector('button');
      btn?.addEventListener('click', () => {
        selectedRoles.delete(role);
        updateSelectedRoles();
      });

      container.appendChild(tag);
    });

    hiddenInput.value = Array.from(selectedRoles).join(', ');
  }

  function setupAutocomplete() {
    const input = document.getElementById('roles-input') as HTMLInputElement;
    const dropdown = document.getElementById('roles-dropdown');

    if (!input || !dropdown) return;

    input.addEventListener('input', (e) => {
      const value = (e.target as HTMLInputElement).value.toLowerCase();

      if (!value) {
        dropdown.classList.remove('active');
        return;
      }

      // Search both canonical roles and aliases, but only show canonical in dropdown
      const matches = roles.filter(role => {
        // Check if canonical role matches
        if (role.toLowerCase().includes(value) && !selectedRoles.has(role)) {
          return true;
        }
        // Check if any alias matches (using the roleMap keys)
        const aliasMatches = Object.keys(roleMap).some(alias => {
          return alias.includes(value) && roleMap[alias] === role && !selectedRoles.has(role);
        });
        return aliasMatches;
      });

      if (matches.length === 0) {
        dropdown.classList.remove('active');
        return;
      }

      dropdown.innerHTML = matches.map(role =>
        `<div class="autocomplete-item" data-role="${role}">${role}</div>`
      ).join('');

      dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', () => {
          const role = item.getAttribute('data-role');
          if (role) {
            selectedRoles.add(role);
            updateSelectedRoles();
            input.value = '';
            dropdown.classList.remove('active');
          }
        });
      });

      dropdown.classList.add('active');
    });

    input.addEventListener('blur', () => {
      setTimeout(() => dropdown.classList.remove('active'), 200);
    });
  }

  async function handleSubmit(e: Event) {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const submitBtn = form.querySelector('.btn-primary') as HTMLButtonElement;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Explicitly handle checkbox value as boolean
    const newsletterCheckbox = document.getElementById('newsletter') as HTMLInputElement;
    const submissionData = {
      ...data,
      newsletter: newsletterCheckbox.checked,
    };

    track('directory_submit', { filmmaker: submissionData });

    try {
      const response = await fetch('/api/submit-filmmaker', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(submissionData),
      });

      if (!response.ok) {
        throw new Error('Failed to submit');
      }

      form.style.display = 'none';
      document.querySelector('.intro')?.remove();
      document.querySelector('h1')?.remove();
      document.getElementById('success-message')!.style.display = 'block';
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to submit. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit';
    }
  }

  async function checkEmailExists(email: string): Promise<boolean> {
    try {
      const response = await fetch(`/api/check-email?email=${encodeURIComponent(email)}`);
      if (!response.ok) return false;
      const data = await response.json();
      return data.exists;
    } catch (error) {
      console.error('Error checking email:', error);
      return false;
    }
  }

  function setupEmailValidation() {
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const emailError = document.getElementById('email-error') as HTMLElement;
    const submitBtn = document.querySelector('.btn-primary') as HTMLButtonElement;

    if (!emailInput || !emailError || !submitBtn) return;

    let checkTimeout: ReturnType<typeof setTimeout>;

    emailInput.addEventListener('input', () => {
      clearTimeout(checkTimeout);
      emailError.style.display = 'none';
      submitBtn.disabled = false;
    });

    emailInput.addEventListener('blur', async () => {
      const email = emailInput.value.trim();
      if (!email) return;

      clearTimeout(checkTimeout);
      checkTimeout = setTimeout(async () => {
        const exists = await checkEmailExists(email);
        if (exists) {
          emailError.textContent = 'This email is already registered in our directory.';
          emailError.style.display = 'block';
          submitBtn.disabled = true;
        } else {
          emailError.style.display = 'none';
          submitBtn.disabled = false;
        }
      }, 300);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupAutocomplete();
    setupEmailValidation();

    const form = document.getElementById('submit-form');
    form?.addEventListener('submit', handleSubmit);
  });
</script>
</BaseLayout>
