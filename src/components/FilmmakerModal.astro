---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div id={id} class="modal">
  <div class="modal-overlay"></div>
  <div class="modal-content">
    <button class="modal-close">&times;</button>
    <div class="modal-body">
      <h2 class="filmmaker-name"></h2>
      <div class="reveal-contact-section">
        <button class="reveal-contact-btn" id="reveal-contact-btn">
          Reveal contact information
        </button>
      </div>
      <table class="filmmaker-details">
        <tbody>
          <tr class="contact-row email-row" style="display: none;">
            <th>Email</th>
            <td><a class="filmmaker-email" href=""></a></td>
          </tr>
          <tr class="contact-row phone-row" style="display: none;">
            <th>Phone</th>
            <td><span class="filmmaker-phone"></span></td>
          </tr>
          <tr>
            <th>Roles</th>
            <td><span class="filmmaker-roles"></span></td>
          </tr>
          <tr class="company-row">
            <th>Company</th>
            <td><span class="filmmaker-company"></span></td>
          </tr>
          <tr class="website-row">
            <th>Website</th>
            <td><a class="filmmaker-website" href="" target="_blank" rel="noopener noreferrer"></a></td>
          </tr>
          <tr class="social-row">
            <th>Social Media</th>
            <td><span class="filmmaker-social"></span></td>
          </tr>
          <tr class="gear-row">
            <th>Equipment/Gear</th>
            <td><span class="filmmaker-gear"></span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.active {
    display: flex;
  }

  .modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    background: white;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #666;
    line-height: 1;
    padding: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    color: #000;
  }

  .modal-body {
    padding: 2rem;
  }

  .filmmaker-name {
    margin: 0 0 1rem;
    color: #1a1a1a;
    font-size: 1.75rem;
  }

  .reveal-contact-section {
    margin-bottom: 1.5rem;
  }

  .reveal-contact-btn {
    padding: 0.625rem 1.25rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .reveal-contact-btn:hover {
    opacity: 0.9;
  }

  .reveal-contact-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .reveal-contact-btn.hidden {
    display: none !important;
  }

  .filmmaker-details {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
  }

  .filmmaker-details th {
    text-align: left;
    padding: 0.75rem 1rem;
    background: #f3f4f6;
    color: #374151;
    font-weight: 600;
    font-size: 0.875rem;
    width: 30%;
    border-bottom: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
  }

  .filmmaker-details td {
    padding: 0.75rem 1rem;
    color: #1a1a1a;
    border-bottom: 1px solid #e5e7eb;
  }

  .filmmaker-details tr:last-child th,
  .filmmaker-details tr:last-child td {
    border-bottom: none;
  }

  /* Remove border from visible last row when some rows are hidden */
  .filmmaker-details tr[style*="display: none"] {
    display: none !important;
  }

  .filmmaker-details tr:not([style*="display: none"]):last-of-type th,
  .filmmaker-details tr:not([style*="display: none"]):last-of-type td {
    border-bottom: none;
  }

  .filmmaker-details a {
    color: #667eea;
    text-decoration: none;
  }

  .filmmaker-details a:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .modal-content {
      width: 95%;
      max-height: 90vh;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .filmmaker-name {
      font-size: 1.5rem;
    }
  }
</style>

<script>
  function setupModal(modalId: string) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    const overlay = modal.querySelector('.modal-overlay');
    const closeBtn = modal.querySelector('.modal-close');

    const close = () => {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    };

    overlay?.addEventListener('click', close);
    closeBtn?.addEventListener('click', close);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        close();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupModal('filmmaker-modal');
  });

  let currentFilmmaker: any = null;
  const contactCache = new Map<number, { email: string | null; phone: string | null }>(); // Cache contact data

  export function openFilmmakerModal(filmmaker: any) {
    const modal = document.getElementById('filmmaker-modal');
    if (!modal) return;

    currentFilmmaker = filmmaker;

    modal.querySelector('.filmmaker-name')!.textContent = filmmaker.name;

    // Check if this filmmaker's contact is in cache
    const cachedContact = contactCache.get(filmmaker.id);

    const revealBtn = document.getElementById('reveal-contact-btn') as HTMLButtonElement;
    const emailRow = modal.querySelector('.email-row') as HTMLElement;
    const phoneRow = modal.querySelector('.phone-row') as HTMLElement;
    const emailLink = modal.querySelector('.filmmaker-email') as HTMLAnchorElement;
    const phoneSpan = modal.querySelector('.filmmaker-phone')!;

    if (cachedContact) {
      // Contact is cached, display it immediately
      revealBtn.classList.add('hidden');

      // Populate email
      if (cachedContact.email) {
        emailLink.textContent = cachedContact.email;
        emailLink.href = `mailto:${cachedContact.email}`;
        emailRow.style.display = 'table-row';
      } else {
        emailRow.style.display = 'none';
      }

      // Populate phone
      if (cachedContact.phone) {
        phoneSpan.textContent = formatPhone(cachedContact.phone);
        phoneRow.style.display = 'table-row';
      } else {
        phoneRow.style.display = 'none';
      }
    } else {
      // Reset to initial state
      if (revealBtn) {
        revealBtn.classList.remove('hidden');
        revealBtn.style.display = 'block';
        revealBtn.disabled = false;
        revealBtn.textContent = 'Reveal contact information';
      }

      // Clear and hide contact rows
      emailLink.textContent = '';
      emailLink.href = '';
      phoneSpan.textContent = '';
      emailRow.style.display = 'none';
      phoneRow.style.display = 'none';
    }

    modal.querySelector('.filmmaker-roles')!.textContent = filmmaker.roles;

    const companyRow = modal.querySelector('.company-row') as HTMLElement;
    const companySpan = modal.querySelector('.filmmaker-company')!;
    if (filmmaker.company) {
      companySpan.textContent = filmmaker.company;
      companyRow.style.display = 'table-row';
    } else {
      companyRow.style.display = 'none';
    }

    const websiteRow = modal.querySelector('.website-row') as HTMLElement;
    const websiteLink = modal.querySelector('.filmmaker-website') as HTMLAnchorElement;
    if (filmmaker.website) {
      websiteLink.textContent = filmmaker.website;
      websiteLink.href = normalizeUrlClient(filmmaker.website);
      websiteRow.style.display = 'table-row';
    } else {
      websiteRow.style.display = 'none';
    }

    const socialRow = modal.querySelector('.social-row') as HTMLElement;
    const socialSpan = modal.querySelector('.filmmaker-social')!;
    if (filmmaker.socialMedia) {
      socialSpan.textContent = filmmaker.socialMedia;
      socialRow.style.display = 'table-row';
    } else {
      socialRow.style.display = 'none';
    }

    const gearRow = modal.querySelector('.gear-row') as HTMLElement;
    const gearSpan = modal.querySelector('.filmmaker-gear')!;
    if (filmmaker.gear) {
      gearSpan.textContent = filmmaker.gear;
      gearRow.style.display = 'table-row';
    } else {
      gearRow.style.display = 'none';
    }

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function formatPhone(phone: string): string {
    const cleaned = phone.replace(/\D/g, '');
    if (cleaned.length === 10) {
      return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 6)}-${cleaned.slice(6)}`;
    }
    return phone;
  }

  function normalizeUrlClient(url: string | null | undefined): string {
    if (!url) return '';
    const trimmed = url.trim();
    if (!trimmed) return '';
    if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {
      return trimmed;
    }
    return `https://${trimmed}`;
  }

  (window as any).openFilmmakerModal = openFilmmakerModal;

  // Setup reveal contact functionality
  document.addEventListener('DOMContentLoaded', () => {
    const revealBtn = document.getElementById('reveal-contact-btn');

    if (revealBtn) {
      revealBtn.addEventListener('click', handleRevealContact);
    }
  });

  async function fetchAndDisplayContact(filmmakerId: number, modal: HTMLElement) {
    const emailRow = modal.querySelector('.email-row') as HTMLElement;
    const phoneRow = modal.querySelector('.phone-row') as HTMLElement;

    try {
      const response = await fetch('/api/reveal-contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filmmakerId }),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to load contact information');
      }

      const data = await response.json();

      // Populate email
      const emailLink = modal.querySelector('.filmmaker-email') as HTMLAnchorElement;
      if (data.email) {
        emailLink.textContent = data.email;
        emailLink.href = `mailto:${data.email}`;
        emailRow.style.display = 'table-row';
      }

      // Populate phone
      const phoneSpan = modal.querySelector('.filmmaker-phone')!;
      if (data.phone) {
        phoneSpan.textContent = formatPhone(data.phone);
        phoneRow.style.display = 'table-row';
      }

      // Cache the contact data
      contactCache.set(filmmakerId, {
        email: data.email || null,
        phone: data.phone || null,
      });
    } catch (error) {
      console.error('Error revealing contact:', error);
      throw error;
    }
  }

  async function handleRevealContact() {
    const modal = document.getElementById('filmmaker-modal');
    if (!modal || !currentFilmmaker) return;

    const revealBtn = document.getElementById('reveal-contact-btn') as HTMLButtonElement;
    if (!revealBtn) return;

    // Disable button and show loading state
    revealBtn.disabled = true;
    revealBtn.textContent = 'Loading...';

    try {
      await fetchAndDisplayContact(currentFilmmaker.id, modal);

      // Hide button
      revealBtn.classList.add('hidden');
    } catch (error) {
      // Show error message and re-enable button
      revealBtn.textContent = error instanceof Error ? error.message : 'Error loading contact info';
      revealBtn.disabled = false;

      // Reset button text after 3 seconds
      setTimeout(() => {
        revealBtn.textContent = 'Reveal contact information';
      }, 3000);
    }
  }
</script>
