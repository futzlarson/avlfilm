---
// Internal imports
import BaseLayout from '@layouts/BaseLayout.astro';

// Redirect if already logged in
const user = Astro.locals.user;
if (user) {
  return Astro.redirect('/account/profile');
}
---

<BaseLayout
  title="Forgot Password"
  description="Reset your AVL Film account password."
>
  <div class="auth-container">
    <h1>Forgot Password</h1>
    <p class="intro">Enter your email address and we'll send you a link to reset your password.</p>

    <form id="forgot-form" class="auth-form">
      <div class="form-group">
        <label for="email">Email <span class="required">*</span></label>
        <input type="email" id="email" name="email" required autocomplete="email" />
      </div>

      <div id="error-message" class="alert alert-error" style="display: none;"></div>
      <div id="success-message" class="alert alert-success" style="display: none;"></div>

      <button type="submit" class="btn-primary btn-large btn-full">Send Reset Link</button>
    </form>

    <div class="auth-links">
      <a href="/account/login">Back to login</a>
    </div>
  </div>
</BaseLayout>

<script>
  const form = document.getElementById('forgot-form') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message') as HTMLElement;
  const successMessage = document.getElementById('success-message') as HTMLElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    const formData = new FormData(form);

    try {
      const response = await fetch('/api/auth/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: formData.get('email'),
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to send reset link');
      }

      successMessage.textContent = data.message || 'If that email exists, a reset link has been sent.';
      successMessage.style.display = 'block';
      form.reset();
      submitBtn.textContent = 'Send Reset Link';
    } catch (error) {
      errorMessage.textContent = error instanceof Error ? error.message : 'Failed to send reset link';
      errorMessage.style.display = 'block';
      submitBtn.textContent = 'Send Reset Link';
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
