---
// Internal imports
import { db } from '@db';
import { spotlightEvents, submissions, reviews, filmmakers } from '@db/schema';
import { formatDuration, calculateTotalRuntime } from '@lib/film-utils';
import { formatDate } from '@lib/datetime';
import BaseLayout from '@layouts/BaseLayout.astro';
import AdminNav from '@components/AdminNav.astro';

// External packages
import { eq, desc, asc } from 'drizzle-orm';

// Get selected filters from query params
const selectedEventId = Astro.url.searchParams.get('event');
const selectedStatus = Astro.url.searchParams.get('status') || 'all';

// Build submission query (conditionally filtered)
let submissionsQuery = db
  .select()
  .from(submissions)
  .orderBy(asc(submissions.sortOrder), desc(submissions.createdAt))
  .$dynamic();

if (selectedEventId) {
  submissionsQuery = submissionsQuery.where(eq(submissions.eventId, Number(selectedEventId)));
}

// Run all queries in parallel
const [allEvents, allSubmissions, allReviews] = await Promise.all([
  db.select({
    id: spotlightEvents.id,
    title: spotlightEvents.title,
  })
  .from(spotlightEvents)
  .orderBy(desc(spotlightEvents.eventDate)),

  submissionsQuery,

  db.select({
    submissionId: reviews.submissionId,
    adminName: filmmakers.name,
    vote: reviews.vote,
    createdAt: reviews.createdAt,
  })
  .from(reviews)
  .innerJoin(filmmakers, eq(reviews.adminId, filmmakers.id)),
]);

// Filter by status client-side if needed (simpler for small datasets)
const filteredSubmissions = selectedStatus === 'all'
  ? allSubmissions
  : allSubmissions.filter(s => s.status === selectedStatus);

// Calculate stats
const stats = {
  total: allSubmissions.length,
  pending: allSubmissions.filter(s => s.status === 'pending').length,
  approved: allSubmissions.filter(s => s.status === 'approved').length,
  rejected: allSubmissions.filter(s => s.status === 'rejected').length,
  future: allSubmissions.filter(s => s.status === 'future').length,
};

const approvedSubs = allSubmissions.filter(s => s.status === 'approved');
const totalRuntime = calculateTotalRuntime(approvedSubs);

// Build review map with voter details for tooltips
const reviewMap = new Map<number, { upVotes: number; downVotes: number; tooltip: string }>();
for (const r of allReviews) {
  if (!reviewMap.has(r.submissionId)) {
    reviewMap.set(r.submissionId, { upVotes: 0, downVotes: 0, tooltip: '' });
  }
  const entry = reviewMap.get(r.submissionId)!;
  if (r.vote === 'up') entry.upVotes++;
  if (r.vote === 'down') entry.downVotes++;
  const emoji = r.vote === 'up' ? 'üëç' : r.vote === 'down' ? 'üëé' : 'üí¨';
  const date = formatDate(r.createdAt, { month: 'short', day: 'numeric' });
  entry.tooltip += `${entry.tooltip ? '\n' : ''}${r.adminName} ${emoji} ‚Äî ${date}`;
}
---

<BaseLayout title="Admin - Submissions">
  <div class="admin-header">
    <h1>Admin</h1>
  </div>

  <AdminNav currentPage="submissions" />

  <div class="admin-section">
    <div class="header-stats-container">
      <div class="header-left">
        <h2 style="margin: 0">Submission Review</h2>
        <div class="filters">
          <div class="filter-group">
            <label for="event-filter">Event:</label>
            <select id="event-filter">
              <option value="">All Events</option>
              {allEvents.map((ev) => (
                <option value={ev.id} selected={selectedEventId === String(ev.id)}>{ev.title}</option>
              ))}
            </select>
          </div>
          <div class="filter-group">
            <label for="status-filter">Status:</label>
            <select id="status-filter">
              {['all', 'pending', 'approved', 'rejected', 'future'].map((s) => (
                <option value={s} selected={selectedStatus === s}>{s === 'all' ? 'All' : s.charAt(0).toUpperCase() + s.slice(1)}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {selectedEventId && (
        <div class="stats-section">
          <table class="stats-table runtime-table">
            <thead>
              <tr>
                <th>Runtime</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="runtime-display">{formatDuration(totalRuntime)}</td>
              </tr>
            </tbody>
          </table>
          <table class="stats-table">
            <thead>
              <tr>
                {stats.pending > 0 && <th>Pending</th>}
                {stats.approved > 0 && <th>Approved</th>}
                {stats.rejected > 0 && <th>Rejected</th>}
                {stats.future > 0 && <th>Future</th>}
              </tr>
            </thead>
            <tbody>
              <tr>
                {stats.pending > 0 && <td class="pending">{stats.pending}</td>}
                {stats.approved > 0 && <td class="approved">{stats.approved}</td>}
                {stats.rejected > 0 && <td class="rejected">{stats.rejected}</td>}
                {stats.future > 0 && <td class="future">{stats.future}</td>}
              </tr>
            </tbody>
          </table>
        </div>
      )}
    </div>

    <!-- Submissions Table -->
    {filteredSubmissions.length === 0 ? (
      <div class="empty-state">No submissions found.</div>
    ) : (
      <table class="submissions-table">
        <thead>
          <tr>
            <th class="drag-col"></th>
            <th>Film Title</th>
            <th>Filmmaker</th>
            <th>Genre</th>
            <th>Length</th>
            <th>Submitted</th>
            <th>Status</th>
            <th>Notes</th>
            <th>Votes</th>
          </tr>
        </thead>
        <tbody>
          {filteredSubmissions.map((sub) => {
            const rv = reviewMap.get(sub.id);
            return (
              <tr data-id={sub.id} draggable="true">
                <td class="drag-handle" title="Drag to reorder">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="6" cy="4" r="1.25" fill="currentColor"/>
                    <circle cx="10" cy="4" r="1.25" fill="currentColor"/>
                    <circle cx="6" cy="8" r="1.25" fill="currentColor"/>
                    <circle cx="10" cy="8" r="1.25" fill="currentColor"/>
                    <circle cx="6" cy="12" r="1.25" fill="currentColor"/>
                    <circle cx="10" cy="12" r="1.25" fill="currentColor"/>
                  </svg>
                </td>
                <td class="title-cell"><a href={`/admin/events/reviews?id=${sub.id}`}>{sub.filmTitle}</a></td>
                <td>
                  {sub.submitterName}
                  <a href={`mailto:${sub.submitterEmail}`} class="email-icon" title={sub.submitterEmail}>
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="1.5" y="3" width="13" height="10" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M1.5 5L8 9.5L14.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </a>
                </td>
                <td>{sub.filmGenre === 'Other' ? sub.filmGenreOther : sub.filmGenre}</td>
                <td>{formatDuration(sub.filmLength)}</td>
                <td class="submitted-cell">{formatDate(sub.createdAt, { month: 'short', day: 'numeric' })}</td>
                <td>
                  {sub.status === 'approved' && sub.fullResVideoUrl ? (
                    <span class="status-badge link">&#10003; Link</span>
                  ) : (
                    <span class={`status-badge ${sub.status}`}>{sub.status}</span>
                  )}
                </td>
                <td class="notes-cell">
                  {sub.adminNotes ? (
                    <span class="has-tooltip">&#128221;<span class="tooltip">{sub.adminNotes}</span></span>
                  ) : '‚Äî'}
                </td>
                <td class="votes-cell">
                  {rv ? (
                    <span class="has-tooltip votes-display">
                      {rv.upVotes > 0 && <span>&#128077;</span>}
                      {rv.downVotes > 0 && <span>&#128078;</span>}
                      {rv.upVotes === 0 && rv.downVotes === 0 && <span>&#128172;</span>}
                      <span class="tooltip">{rv.tooltip}</span>
                    </span>
                  ) : (
                    <span class="no-votes">‚Äî</span>
                  )}
                </td>
              </tr>
            );
          })}
          {selectedEventId && (
            <tr class="action-row">
              <td></td>
              <td colspan="5"></td>
              <td colspan="3">
                <button class="btn-secondary" id="request-files-btn" type="button">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2V8M8 8V14M8 8H14M8 8H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Request Files
                </button>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    )}
  </div>

  <!-- Confirmation Modal -->
  <div id="request-files-modal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-small">
      <button class="modal-close">&times;</button>
      <div class="modal-body">
        <h2>Request Files</h2>
        <p id="modal-message"></p>
        <div class="table-wrapper">
          <table id="modal-email-table" class="modal-table">
            <thead>
              <tr>
                <th>Film Title</th>
                <th>Email</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="modal-email-list"></tbody>
          </table>
        </div>
        <div class="modal-actions">
          <button class="btn-secondary" id="modal-cancel-btn">Cancel</button>
          <button class="btn-primary" id="modal-confirm-btn">Send Emails</button>
        </div>
      </div>
    </div>
  </div>

</BaseLayout>

<script id="submissions-data" type="application/json" set:html={JSON.stringify({
  approvedWithoutFiles: allSubmissions
    .filter(s => s.status === 'approved' && !s.fullResVideoUrl && selectedEventId && s.eventId === Number(selectedEventId))
    .map(s => ({ id: s.id, email: s.submitterEmail, filmTitle: s.filmTitle, status: s.status }))
})}></script>

<script>
  import { setupModal } from '@lib/modal';

  // Setup modal
  const requestFilesModal = setupModal('request-files-modal');

  // Filter navigation
  const eventFilter = document.getElementById('event-filter') as HTMLSelectElement;
  const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;

  function applyFilters() {
    const params = new URLSearchParams();
    if (eventFilter.value) params.set('event', eventFilter.value);
    if (statusFilter.value && statusFilter.value !== 'all') params.set('status', statusFilter.value);
    window.location.search = params.toString();
  }

  eventFilter.addEventListener('change', applyFilters);
  statusFilter.addEventListener('change', applyFilters);

  // Request files for all approved submissions without full-res video
  const requestFilesBtn = document.getElementById('request-files-btn');
  if (requestFilesBtn && requestFilesModal) {
    requestFilesBtn.addEventListener('click', () => {
      const data = JSON.parse(document.getElementById('submissions-data')?.textContent || '{}');
      const submissions = data.approvedWithoutFiles || [];

      if (submissions.length === 0) {
        alert('No approved submissions need file requests.');
        return;
      }

      // Populate modal
      const modalMessage = document.getElementById('modal-message')!;
      const modalEmailList = document.getElementById('modal-email-list')!;

      modalMessage.textContent = `Send file request emails to ${submissions.length} filmmaker${submissions.length > 1 ? 's' : ''}?`;
      modalEmailList.innerHTML = submissions.map((s: any) =>
        `<tr>
          <td>${s.filmTitle}</td>
          <td>${s.email}</td>
          <td><span class="status-badge ${s.status}">${s.status}</span></td>
        </tr>`
      ).join('');

      requestFilesModal.open();
    });

    // Cancel button
    document.getElementById('modal-cancel-btn')?.addEventListener('click', () => {
      requestFilesModal?.close();
    });

    // Confirm button
    document.getElementById('modal-confirm-btn')?.addEventListener('click', async () => {
      const data = JSON.parse(document.getElementById('submissions-data')?.textContent || '{}');
      const submissions = data.approvedWithoutFiles || [];

      const btn = document.getElementById('modal-confirm-btn') as HTMLButtonElement;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const results = await Promise.all(
          submissions.map((s: any) =>
            fetch('/admin/api/submissions/request-file', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ submissionId: s.id }),
            })
          )
        );

        const allSuccessful = results.every(r => r.ok);
        if (!allSuccessful) {
          throw new Error('Some emails failed to send');
        }

        // Update the Request Files button
        const requestBtn = document.getElementById('request-files-btn') as HTMLButtonElement;
        const reqOriginalText = requestBtn.textContent;
        requestBtn.textContent = `‚úì ${submissions.length} Email${submissions.length > 1 ? 's' : ''} Sent`;
        requestBtn.style.background = '#10b981';

        requestFilesModal?.close();

        setTimeout(() => {
          requestBtn.textContent = reqOriginalText;
          requestBtn.style.background = '';
        }, 3000);
      } catch (err) {
        console.error('Failed to send file requests', err);
        alert('Failed to send some file request emails');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  }

  // Drag and drop reordering
  const tbody = document.querySelector('.submissions-table tbody') as HTMLTableSectionElement | null;
  if (tbody) {
    let dragRow: HTMLTableRowElement | null = null;

    tbody.addEventListener('dragstart', (e) => {
      const row = (e.target as HTMLElement).closest('tr') as HTMLTableRowElement;
      if (!row) return;
      dragRow = row;
      row.classList.add('dragging');
      e.dataTransfer!.effectAllowed = 'move';
    });

    tbody.addEventListener('dragend', () => {
      if (dragRow) dragRow.classList.remove('dragging');
      dragRow = null;
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    tbody.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer!.dropEffect = 'move';
      const targetRow = (e.target as HTMLElement).closest('tr') as HTMLTableRowElement;
      if (!targetRow || targetRow === dragRow) return;

      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      targetRow.classList.add('drag-over');

      const rows = [...tbody.querySelectorAll('tr')];
      const dragIdx = rows.indexOf(dragRow!);
      const targetIdx = rows.indexOf(targetRow);

      if (dragIdx < targetIdx) {
        targetRow.after(dragRow!);
      } else {
        targetRow.before(dragRow!);
      }
    });

    tbody.addEventListener('drop', async (e) => {
      e.preventDefault();
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

      const rows = [...tbody.querySelectorAll('tr')];
      const order = rows.map((row, i) => ({
        id: Number(row.dataset.id),
        sortOrder: i,
      }));

      try {
        const res = await fetch('/admin/api/submissions/reorder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order }),
        });
        if (!res.ok) {
          console.error('Failed to save order');
        }
      } catch (err) {
        console.error('Failed to save order', err);
      }
    });
  }
</script>

<style>
  .header-stats-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .header-left {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .filters {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-group label {
    font-weight: 600;
    white-space: nowrap;
  }

  .filter-group select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-md);
    font-family: inherit;
  }

  .stats-section {
    display: flex;
    gap: 1.5rem;
  }

  .runtime-table .runtime-display {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .stats-table {
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .stats-table th {
    padding: 0.15rem 0.75rem 0;
    font-weight: 600;
    color: #6b7280;
    text-align: center;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stats-table td {
    padding: 0 0.75rem 0.25rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .stats-table .pending { color: #92400e; }
  .stats-table .approved { color: #065f46; }
  .stats-table .rejected { color: #991b1b; }
  .stats-table .future { color: #1e40af; }

  .action-row td {
    border-bottom: none !important;
    padding-top: 1rem;
  }

  .submissions-table tr:has(+ .action-row) td {
    border-bottom: none;
  }

  .drag-col {
    width: 2rem;
  }

  .drag-handle {
    cursor: grab;
    color: #d1d5db;
    text-align: center;
    width: 2rem;
  }

  .drag-handle:hover {
    color: #6b7280;
  }

  .submissions-table tr[draggable="true"] {
    transition: opacity 0.15s;
  }

  .submissions-table tr.dragging {
    opacity: 0.4;
  }

  .submissions-table tr.drag-over td {
    border-top: 2px solid var(--color-primary);
  }

  .submissions-table {
    width: 100%;
    border-collapse: collapse;
  }

  .submissions-table th,
  .submissions-table td {
    padding: 0.65rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .submissions-table th {
    font-weight: 600;
    color: #6b7280;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .title-cell {
    font-weight: 500;
  }

  .votes-cell {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .notes-cell {
    text-align: center;
    font-size: 1rem;
  }

  .submitted-cell {
    color: #6b7280;
    white-space: nowrap;
  }

  .votes-display {
    white-space: nowrap;
    display: inline-flex;
    gap: 0.35rem;
    font-size: 1rem;
  }

  .email-icon {
    margin-left: 0.35rem;
    color: #9ca3af;
    vertical-align: middle;
  }

  .email-icon:hover {
    color: var(--color-primary);
    text-decoration: none !important;
  }

  .btn-sm {
    display: inline-block;
    padding: 0.3rem 0.75rem;
    font-size: 0.85rem;
    background: var(--color-bg-subtle);
    border: 1px solid #d1d5db;
    border-radius: var(--radius-md);
    color: #374151;
    text-decoration: none;
    cursor: pointer;
  }

  .btn-sm:hover { background: #e5e7eb; }

  .submissions-table td a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .submissions-table td a:hover {
    text-decoration: underline;
  }

  /* Modal styles */
  :global(.modal-small) {
    max-width: 650px;
  }

  :global(.modal-body) {
    padding: 2rem;
  }

  :global(.modal-body h2) {
    margin: 0 0 1rem;
    font-size: 1.5rem;
    color: #111827;
  }

  :global(.modal-body p) {
    margin: 0 0 1rem;
    color: #374151;
  }

  :global(#request-files-modal .table-wrapper) {
    max-height: 350px;
    overflow-y: auto;
    margin-bottom: 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  :global(#request-files-modal .modal-table) {
    width: 100%;
    border-collapse: collapse;
  }

  :global(#request-files-modal .modal-table th),
  :global(#request-files-modal .modal-table td) {
    padding: 0.65rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  :global(#request-files-modal .modal-table th) {
    position: sticky;
    top: 0;
    font-weight: 600;
    color: #6b7280;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: white;
    z-index: 1;
  }

  :global(#request-files-modal .modal-table tbody tr:hover) {
    background: #f9fafb;
  }

  :global(#request-files-modal .modal-table td:nth-child(2)) {
    color: #6b7280;
  }

  :global(#request-files-modal .modal-table td:first-child) {
    font-weight: 500;
  }

  :global(.modal-actions) {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
  }
</style>
