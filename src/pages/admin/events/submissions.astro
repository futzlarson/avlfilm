---
// Internal imports
import { db } from '@db';
import { spotlightEvents, submissions, reviews } from '@db/schema';
import { formatDuration, calculateTotalRuntime } from '@lib/film-utils';
import BaseLayout from '@layouts/BaseLayout.astro';
import AdminNav from '@components/AdminNav.astro';

// External packages
import { eq, desc, asc, count, sql } from 'drizzle-orm';

// Get selected filters from query params
const selectedEventId = Astro.url.searchParams.get('event');
const selectedStatus = Astro.url.searchParams.get('status') || 'all';

// Build submission query (conditionally filtered)
let submissionsQuery = db
  .select()
  .from(submissions)
  .orderBy(asc(submissions.sortOrder), desc(submissions.createdAt))
  .$dynamic();

if (selectedEventId) {
  submissionsQuery = submissionsQuery.where(eq(submissions.eventId, Number(selectedEventId)));
}

// Run all queries in parallel
const [allEvents, allSubmissions, reviewSummaries] = await Promise.all([
  db.select({
    id: spotlightEvents.id,
    title: spotlightEvents.title,
  })
  .from(spotlightEvents)
  .orderBy(desc(spotlightEvents.eventDate)),

  submissionsQuery,

  db.select({
    submissionId: reviews.submissionId,
    totalVotes: count(reviews.vote),
    upVotes: sql<number>`count(case when ${reviews.vote} = 'up' then 1 end)`,
    downVotes: sql<number>`count(case when ${reviews.vote} = 'down' then 1 end)`,
  })
  .from(reviews)
  .groupBy(reviews.submissionId),
]);

// Filter by status client-side if needed (simpler for small datasets)
const filteredSubmissions = selectedStatus === 'all'
  ? allSubmissions
  : allSubmissions.filter(s => s.status === selectedStatus);

// Calculate stats
const stats = {
  total: allSubmissions.length,
  pending: allSubmissions.filter(s => s.status === 'pending').length,
  approved: allSubmissions.filter(s => s.status === 'approved').length,
  rejected: allSubmissions.filter(s => s.status === 'rejected').length,
  future: allSubmissions.filter(s => s.status === 'future').length,
};

const approvedSubs = allSubmissions.filter(s => s.status === 'approved');
const totalRuntime = calculateTotalRuntime(approvedSubs);

const reviewMap = new Map(reviewSummaries.map(r => [r.submissionId, r]));
---

<BaseLayout title="Admin - Submissions">
  <div class="admin-header">
    <h1>Admin</h1>
  </div>

  <AdminNav currentPage="submissions" />

  <div class="admin-section">
    <h2 style="margin-top: 0; margin-bottom: 1rem">Submission Review</h2>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="event-filter">Event:</label>
        <select id="event-filter">
          <option value="">All Events</option>
          {allEvents.map((ev) => (
            <option value={ev.id} selected={selectedEventId === String(ev.id)}>{ev.title}</option>
          ))}
        </select>
      </div>
      <div class="filter-group">
        <label for="status-filter">Status:</label>
        <select id="status-filter">
          {['all', 'pending', 'approved', 'rejected', 'future'].map((s) => (
            <option value={s} selected={selectedStatus === s}>{s === 'all' ? 'All' : s.charAt(0).toUpperCase() + s.slice(1)}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Stats -->
    {selectedEventId && (
      <div class="stats-section">
        <div class="runtime-display">{formatDuration(totalRuntime)}</div>
        <table class="stats-table">
          <thead>
            <tr>
              <th>Total</th>
              <th>Pending</th>
              <th>Approved</th>
              <th>Rejected</th>
              <th>Future</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{stats.total}</td>
              <td class="pending">{stats.pending}</td>
              <td class="approved">{stats.approved}</td>
              <td class="rejected">{stats.rejected}</td>
              <td class="future">{stats.future}</td>
            </tr>
          </tbody>
        </table>
      </div>
    )}

    <!-- Submissions Table -->
    {filteredSubmissions.length === 0 ? (
      <div class="empty-state">No submissions found.</div>
    ) : (
      <table class="submissions-table">
        <thead>
          <tr>
            <th class="drag-col"></th>
            <th>Film Title</th>
            <th>Filmmaker</th>
            <th>Genre</th>
            <th>Length</th>
            <th>Status</th>
            <th>Notes</th>
            <th>Votes</th>
          </tr>
        </thead>
        <tbody>
          {filteredSubmissions.map((sub) => {
            const rv = reviewMap.get(sub.id);
            return (
              <tr data-id={sub.id} draggable="true">
                <td class="drag-handle" title="Drag to reorder">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="6" cy="4" r="1.25" fill="currentColor"/>
                    <circle cx="10" cy="4" r="1.25" fill="currentColor"/>
                    <circle cx="6" cy="8" r="1.25" fill="currentColor"/>
                    <circle cx="10" cy="8" r="1.25" fill="currentColor"/>
                    <circle cx="6" cy="12" r="1.25" fill="currentColor"/>
                    <circle cx="10" cy="12" r="1.25" fill="currentColor"/>
                  </svg>
                </td>
                <td class="title-cell"><a href={`/admin/events/reviews?id=${sub.id}`}>{sub.filmTitle}</a></td>
                <td>
                  {sub.submitterName}
                  <a href={`mailto:${sub.submitterEmail}`} class="email-icon" title={sub.submitterEmail}>
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="1.5" y="3" width="13" height="10" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M1.5 5L8 9.5L14.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </a>
                </td>
                <td>{sub.filmGenre === 'Other' ? sub.filmGenreOther : sub.filmGenre}</td>
                <td>{formatDuration(sub.filmLength)}</td>
                <td><span class={`status-badge ${sub.status}`}>{sub.status}</span></td>
                <td class="notes-cell">{sub.adminNotes || '—'}</td>
                <td class="votes-cell">
                  {rv ? (
                    <span>{rv.upVotes} up / {rv.downVotes} down</span>
                  ) : (
                    <span class="no-votes">—</span>
                  )}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    )}
  </div>

</BaseLayout>

<script>
  // Filter navigation
  const eventFilter = document.getElementById('event-filter') as HTMLSelectElement;
  const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;

  function applyFilters() {
    const params = new URLSearchParams();
    if (eventFilter.value) params.set('event', eventFilter.value);
    if (statusFilter.value && statusFilter.value !== 'all') params.set('status', statusFilter.value);
    window.location.search = params.toString();
  }

  eventFilter.addEventListener('change', applyFilters);
  statusFilter.addEventListener('change', applyFilters);

  // Drag and drop reordering
  const tbody = document.querySelector('.submissions-table tbody') as HTMLTableSectionElement | null;
  if (tbody) {
    let dragRow: HTMLTableRowElement | null = null;

    tbody.addEventListener('dragstart', (e) => {
      const row = (e.target as HTMLElement).closest('tr') as HTMLTableRowElement;
      if (!row) return;
      dragRow = row;
      row.classList.add('dragging');
      e.dataTransfer!.effectAllowed = 'move';
    });

    tbody.addEventListener('dragend', () => {
      if (dragRow) dragRow.classList.remove('dragging');
      dragRow = null;
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    tbody.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer!.dropEffect = 'move';
      const targetRow = (e.target as HTMLElement).closest('tr') as HTMLTableRowElement;
      if (!targetRow || targetRow === dragRow) return;

      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      targetRow.classList.add('drag-over');

      const rows = [...tbody.querySelectorAll('tr')];
      const dragIdx = rows.indexOf(dragRow!);
      const targetIdx = rows.indexOf(targetRow);

      if (dragIdx < targetIdx) {
        targetRow.after(dragRow!);
      } else {
        targetRow.before(dragRow!);
      }
    });

    tbody.addEventListener('drop', async (e) => {
      e.preventDefault();
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

      const rows = [...tbody.querySelectorAll('tr')];
      const order = rows.map((row, i) => ({
        id: Number(row.dataset.id),
        sortOrder: i,
      }));

      try {
        const res = await fetch('/admin/api/submissions/reorder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order }),
        });
        if (!res.ok) {
          console.error('Failed to save order');
        }
      } catch (err) {
        console.error('Failed to save order', err);
      }
    });
  }
</script>

<style>
  .filters {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .filter-group label {
    font-weight: 600;
    white-space: nowrap;
  }

  .filter-group select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-md);
    font-family: inherit;
  }

  .stats-section {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .runtime-display {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .stats-table {
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .stats-table th {
    padding: 0.25rem 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-align: center;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stats-table td {
    padding: 0.25rem 0.75rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .stats-table .pending { color: #92400e; }
  .stats-table .approved { color: #065f46; }
  .stats-table .rejected { color: #991b1b; }
  .stats-table .future { color: #1e40af; }

  .drag-col {
    width: 2rem;
  }

  .drag-handle {
    cursor: grab;
    color: #d1d5db;
    text-align: center;
    width: 2rem;
  }

  .drag-handle:hover {
    color: #6b7280;
  }

  .submissions-table tr[draggable="true"] {
    transition: opacity 0.15s;
  }

  .submissions-table tr.dragging {
    opacity: 0.4;
  }

  .submissions-table tr.drag-over td {
    border-top: 2px solid var(--color-primary);
  }

  .submissions-table {
    width: 100%;
    border-collapse: collapse;
  }

  .submissions-table th,
  .submissions-table td {
    padding: 0.65rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .submissions-table th {
    font-weight: 600;
    color: #6b7280;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .title-cell {
    font-weight: 500;
  }

  .votes-cell {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .notes-cell {
    font-size: 0.85rem;
    color: #6b7280;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .no-votes {
    color: #9ca3af;
    font-style: italic;
  }

  .email-icon {
    margin-left: 0.35rem;
    color: #9ca3af;
    vertical-align: middle;
  }

  .email-icon:hover {
    color: var(--color-primary);
    text-decoration: none !important;
  }

  .btn-sm {
    display: inline-block;
    padding: 0.3rem 0.75rem;
    font-size: 0.85rem;
    background: var(--color-bg-subtle);
    border: 1px solid #d1d5db;
    border-radius: var(--radius-md);
    color: #374151;
    text-decoration: none;
    cursor: pointer;
  }

  .btn-sm:hover { background: #e5e7eb; }

  .submissions-table td a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .submissions-table td a:hover {
    text-decoration: underline;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #9ca3af;
  }
</style>
