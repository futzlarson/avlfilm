---
// Internal imports
import { db } from '@db';
import { filmmakers } from '@db/schema';
import type { Filmmaker } from '@db/schema';
import BaseLayout from '@layouts/BaseLayout.astro';
import FilmmakerCard from '@components/FilmmakerCard.astro';
import AdminNav from '@components/AdminNav.astro';

// Load all filmmakers on server
let allFilmmakers: Filmmaker[] = [];

try {
  allFilmmakers = await db.select().from(filmmakers) as Filmmaker[];
} catch (error) {
  console.error('Failed to load filmmakers:', error);
}

// Filter pending for display
const pendingFilmmakers = allFilmmakers.filter(f => f.status === 'pending');
---

<BaseLayout title="Admin - Filmmakers">
  <div class="admin-header">
    <h1>Admin</h1>
  </div>

  <AdminNav currentPage="filmmakers" />

  {pendingFilmmakers.length > 0 && (
    <div class="admin-section">
      <h2>Pending Submissions: <span id="pending-count">{pendingFilmmakers.length}</span></h2>
      <div id="pending-filmmakers">
        {pendingFilmmakers.map(f => <FilmmakerCard filmmaker={f} showApproveButton={true} />)}
      </div>
    </div>
  )}

  <div class="admin-section">
    <h2>Filmmaker Search</h2>
    <div class="search-bar">
      <input
        type="text"
        id="search-input"
        placeholder="Search by name or email..."
        autocomplete="off"
      />
    </div>
    <div id="all-filmmakers">
      {allFilmmakers.map(f => (
        <FilmmakerCard filmmaker={f} showApproveButton={false} />
      ))}
      <div class="empty-state" id="no-results" style="display: none;">No filmmakers found</div>
    </div>
  </div>
</BaseLayout>

<style>
  h2 {
    margin: 0 0 1.5rem;
    color: #333;
  }

  .search-bar {
    margin-bottom: 1.5rem;
  }

  .search-bar input {
    width: 100%;
    max-width: 500px;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-md);
    font-size: 1rem;
    font-family: inherit;
  }

  .search-bar input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  :global(.filmmaker-card) {
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: var(--color-bg-subtle);
    border-radius: var(--radius-lg);
    border: 2px solid var(--color-border);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  :global(.filmmaker-card.editing) {
    background: #fff;
    border: 2px solid var(--color-primary);
  }

  :global(.filmmaker-actions),
  :global(.view-actions) {
    display: flex;
    gap: 0.75rem;
    flex-wrap: nowrap;
  }

  :global(.filmmaker-actions) {
    flex-shrink: 0;
  }

  :global(.status-display) {
    display: inline;
  }

  :global(.status-badge) {
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  :global(.status-badge.pending) {
    background: #fef3c7;
    color: #92400e;
  }

  :global(.status-badge.approved) {
    background: #d1fae5;
    color: #065f46;
  }

  :global(.status-badge.archived) {
    background: #fee2e2;
    color: #991b1b;
  }

  :global(.edit-actions) {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  :global(.btn) {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  :global(.btn:hover) {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  :global(.btn:active) {
    transform: translateY(0);
  }

  :global(.btn-approve),
  :global(.btn-save) {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }

  :global(.btn-approve:hover),
  :global(.btn-save:hover) {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
  }

  :global(.btn-archive) {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
  }

  :global(.btn-archive:hover) {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  }

  :global(.btn-edit) {
    background: var(--gradient-primary);
    color: white;
  }

  :global(.btn-edit:hover) {
    background: linear-gradient(135deg, #5568d3 0%, #6b4199 100%);
  }

  :global(.btn-cancel) {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
  }

  :global(.btn-cancel:hover) {
    background: var(--color-border);
  }

  :global(.info-table) {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: 0 0 0 1px var(--color-border);
  }

  :global(.info-table td) {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  :global(.info-table tr:last-child td) {
    border-bottom: none;
  }

  :global(.info-table td:first-child) {
    font-weight: 600;
    color: #f3f4f6;
    text-transform: uppercase;
    font-size: 0.8125rem;
    letter-spacing: 0.05em;
    width: 140px;
    background: #4b5563;
    border-right: 1px solid var(--color-border);
  }

  :global(.info-table td:last-child) {
    color: #1a1a1a;
  }

  :global(.info-table input),
  :global(.info-table textarea),
  :global(.info-table select) {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 0.9375rem;
    box-sizing: border-box;
  }

  :global(.info-table input:read-only),
  :global(.info-table textarea:read-only) {
    border: none;
    padding: 0;
    background: transparent;
    resize: none;
    cursor: default;
    -webkit-appearance: none;
    appearance: none;
  }

  :global(.info-table select:disabled) {
    border: none;
    padding: 0;
    background: transparent;
    cursor: default;
    -webkit-appearance: none;
    appearance: none;
    color: #1a1a1a;
  }

  :global(.info-table input:read-only:focus),
  :global(.info-table textarea:read-only:focus),
  :global(.info-table select:disabled:focus) {
    outline: none;
  }

  :global(.info-table tr.empty-row) {
    display: none;
  }

  /* Hide all search cards by default, only show when matching search */
  #all-filmmakers :global(.filmmaker-card) {
    display: none;
  }

  #all-filmmakers :global(.filmmaker-card.visible) {
    display: block;
  }

  /* Social media field display/edit toggling */
  :global(.social-display) {
    display: inline;
  }

  :global(.info-table tr[data-field="website"] input),
  :global(.info-table tr[data-field="instagram"] input),
  :global(.info-table tr[data-field="youtube"] input),
  :global(.info-table tr[data-field="facebook"] input) {
    display: none;
  }

  :global(.filmmaker-card.editing .info-table tr[data-field="website"] input),
  :global(.filmmaker-card.editing .info-table tr[data-field="instagram"] input),
  :global(.filmmaker-card.editing .info-table tr[data-field="youtube"] input),
  :global(.filmmaker-card.editing .info-table tr[data-field="facebook"] input) {
    display: block;
  }

  :global(.filmmaker-card.editing .social-display) {
    display: none !important;
  }

  @media (max-width: 768px) {
    .admin-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

<script>
  import type { Filmmaker } from '@db/schema';

  function filterSearchResults() {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const containerEl = document.getElementById('all-filmmakers');
    const noResults = document.getElementById('no-results') as HTMLElement;

    if (!containerEl || !searchInput) return;

    const searchTerm = searchInput.value.toLowerCase().trim();

    // Get all filmmaker cards in search section
    const cards = containerEl.querySelectorAll('.filmmaker-card');

    // Hide all cards if no search term
    if (!searchTerm) {
      cards.forEach(card => card.classList.remove('visible'));
      noResults.style.display = 'none';
      return;
    }

    // Filter and show matching cards
    let visibleCount = 0;
    cards.forEach(card => {
      const htmlCard = card as HTMLElement;
      const name = htmlCard.dataset.name || '';
      const email = htmlCard.dataset.email || '';

      if (name.includes(searchTerm) || email.includes(searchTerm)) {
        htmlCard.classList.add('visible');
        visibleCount++;
      } else {
        htmlCard.classList.remove('visible');
      }
    });

    // Show/hide no results message
    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
  }

  function toggleEditMode(card: Element) {
    const formEl = card.querySelector('form');
    const editActionsEl = card.querySelector('.edit-actions') as HTMLElement;
    const viewActionsEl = card.querySelector('.view-actions') as HTMLElement;
    const inputs = formEl?.querySelectorAll('input, textarea');
    const selectEl = formEl?.querySelector('select[name="status"]') as HTMLSelectElement;
    const statusDisplay = formEl?.querySelector('.status-display') as HTMLElement;
    const allRows = formEl?.querySelectorAll('tr[data-field]');
    const statusRow = formEl?.querySelector('tr[data-field="status"]') as HTMLElement;

    // Get social display elements and inputs
    const socialDisplays = formEl?.querySelectorAll('.social-display') as NodeListOf<HTMLElement>;
    const socialInputs = formEl?.querySelectorAll('input[name="website"], input[name="instagram"], input[name="youtube"], input[name="facebook"]') as NodeListOf<HTMLInputElement>;

    if (!formEl || !editActionsEl || !viewActionsEl || !inputs) return;

    const isEditing = !inputs[0].hasAttribute('readonly');

    if (isEditing) {
      // Reset form to original values first
      formEl.reset();
      // Cancel editing
      card.classList.remove('editing');
      inputs.forEach(input => {
        (input as HTMLInputElement).setAttribute('readonly', '');
      });
      // Toggle status: show badge, hide select
      if (selectEl && statusDisplay) {
        selectEl.style.display = 'none';
        statusDisplay.style.display = 'inline';
      }
      // Show social links, hide inputs
      socialDisplays?.forEach(display => {
        display.style.display = 'inline';
      });
      socialInputs?.forEach(input => {
        input.style.display = 'none';
      });
      editActionsEl.style.setProperty('display', 'none');
      viewActionsEl.style.setProperty('display', 'flex');
      // Hide empty rows in display mode (but keep status row visible)
      allRows?.forEach(row => {
        if (row.classList.contains('empty-row')) {
          (row as HTMLElement).style.display = 'none';
        }
      });
    } else {
      // Start editing
      card.classList.add('editing');
      inputs.forEach(input => {
        (input as HTMLInputElement).removeAttribute('readonly');
      });
      // Toggle status: show select, hide badge
      if (selectEl && statusDisplay) {
        selectEl.style.display = 'block';
        statusDisplay.style.display = 'none';
      }
      // Hide social links, show inputs
      socialDisplays?.forEach(display => {
        display.style.display = 'none';
      });
      socialInputs?.forEach(input => {
        input.style.display = 'block';
      });
      editActionsEl.style.setProperty('display', 'flex');
      viewActionsEl.style.setProperty('display', 'none');
      // Show all rows in edit mode, including status and empty ones
      allRows?.forEach(row => {
        (row as HTMLElement).style.display = 'table-row';
      });
      if (statusRow) statusRow.style.display = 'table-row';
    }
  }

  async function approveFilmmaker(id: number) {
    const card = document.querySelector(`[data-id="${id}"]`);
    const btn = card?.querySelector('.btn-approve') as HTMLButtonElement;
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Approving...';
    }
    await updateFilmmaker(id, { status: 'approved' });
  }

  async function archiveFilmmaker(id: number) {
    const card = document.querySelector(`[data-id="${id}"]`);
    const btn = card?.querySelector('.btn-archive') as HTMLButtonElement;
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Archiving...';
    }
    await updateFilmmaker(id, { status: 'archived' });
  }

  async function updateFilmmaker(id: number, data: Partial<Filmmaker>) {
    try {
      const response = await fetch('/api/approve-filmmaker', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id, ...data }),
      });

      if (!response.ok) {
        throw new Error('Failed to update filmmaker');
      }

      // Reload page to get fresh data
      window.location.reload();
    } catch (error) {
      console.error('Error updating filmmaker:', error);
      alert('Failed to update filmmaker');
    }
  }

  function toggleEditAll(id: number) {
    const card = document.querySelector(`#all-filmmakers [data-id="${id}"]`);
    if (card) toggleEditMode(card);
  }

  function toggleEditPending(id: number) {
    const card = document.querySelector(`#pending-filmmakers [data-id="${id}"]`);
    if (card) toggleEditMode(card);
  }

  async function saveFilmmaker(event: Event, id: number) {
    event.preventDefault();
    const form = event.target as HTMLFormElement;
    const btn = form.querySelector('.btn-save') as HTMLButtonElement;
    const card = form.closest('.filmmaker-card');
    const isInSearch = card?.closest('#all-filmmakers') !== null;

    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Saving...';
    }

    // If in search section, preserve search term in URL
    if (isInSearch) {
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      const searchTerm = searchInput?.value || '';
      if (searchTerm) {
        const url = new URL(window.location.href);
        url.searchParams.set('search', searchTerm);
        window.history.replaceState({}, '', url);
      }
    }

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    await updateFilmmaker(id, data);
  }

  (window as any).approveFilmmaker = approveFilmmaker;
  (window as any).archiveFilmmaker = archiveFilmmaker;
  (window as any).toggleEditAll = toggleEditAll;
  (window as any).toggleEditPending = toggleEditPending;
  (window as any).saveFilmmaker = saveFilmmaker;

  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    searchInput?.addEventListener('input', filterSearchResults);

    // Restore search term from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get('search');
    if (searchTerm && searchInput) {
      searchInput.value = searchTerm;
      filterSearchResults();
    }

  });
</script>
</BaseLayout>
